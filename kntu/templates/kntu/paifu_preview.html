{% extends 'nnkr/base.html' %}

{% block content %}

<div class="pt-1 text-center">
  <h3>牌譜再生</h3>
</div><hr>


<div class="container">
  <div class="row">

    <!-- 点数グラフ -->
    <div>
      <canvas id="line-chart" height="25px" width="100px"></canvas>

      <script>
        // get score_infos as dict 
        var score_infos = {{ score_infos | safe }}

        // create datasets
        var bgcolors = [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)'
        ]
        var bcolors = [
          'rgba(255, 99, 132, 0.9)',
          'rgba(54, 162, 235, 0.9)',
          'rgba(255,206,  86, 0.9)',
          'rgba( 75,192, 192, 0.9)'
        ]
        var datasets = []
        for(const [i, score_info] of score_infos.score_data.entries()){
          datasets.push(
            {
              label: score_info.name,
              data:  score_info.scores,
              backgroundColor: bgcolors[i],
              borderColor: bcolors[i],
              pointStyle: 'circle',
              pointRadius: 10,
              pointHoverRadius: 15,
            }
          );
        }

        // draw chart
        var ctx = document.getElementById("line-chart");
        var myLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: score_infos.labels,
            datasets: datasets,
          },
          options: {
            animation: { duration: 2000 },
          },
        });
      </script>
    </div>


    <!-- 牌譜 -->
    <div class="offset-md-1 offset-lg-0 col-md-10 col-lg-8">
      {% for paifu, name in paifu_infos %}
        <details class="border border-4 bg-white mb-2">
          <summary><b style="font-size:20px">{{ name }}</b></summary>
          <div id="paifu-{{ forloop.counter0 }}">
            <iframe src="{{ 'https://tenhou.net/5/?tw='|addstr:seat|add:'&tj=1'|add:'&json='|add:paifu }}"
            style="width: 100%; aspect-ratio: 3/2;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
          </div>
        </details>
      {% empty %}
        <div class="alert alert alert-info alert-dismissible shadow-sm" role="alert">
          <h4><i class="bi bi-info-circle"></i> 説明</h4>
          <ul>
            <li>雀魂の牌譜URLを読み込んで再生します。匿名シェアのURLには対応していません。</li>
            <li>牌譜の再生は天鳳レビュアーで行います。これを利用して雀魂の牌譜をNAGAで解析できます。</li>
            <li>牌譜をjson形式でダウンロードできます。akochanでの解析などにご利用ください。</li>
          </ul>
        </div>
      {% endfor %}
    </div>

    
    <!-- 入力 -->
    <div class="col-lg-4">
      <!-- 読み込みフォーム -->
      <form action="{% url 'kntu:paifu_preview' %}" method="POST" class="submit-only-one">{% csrf_token %}
        
        {{ form.seat }}
        <div class="input-group mb-3">
          <input 
            type="{{form.url.field.widget.input_type}}"
            class="form-control" 
            {% if form.url.field.required %}required{% endif %}
            name="{{form.url.name}}"
            id="{{form.url.id_for_label}}"
            placeholder="牌譜URL" 
            {% if form.url.value %}value="{{form.url.value}}"{% endif %}>
          <button class="btn btn-primary" type="submit" id="button-addon2">読み込み</button>
        </div>
      </form>

      <!-- 牌譜ダウンロード -->
      {% if paifu_json %}
        <div>
          <a href="javascript:download();">牌譜をダウンロード</a>
        </div>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

{% block extrajs %}
  <script>
    const paifudata = {{ paifu_json | safe }}; // get paifudata as json
    function download(){
      let a = document.createElement("a");
      a.href = URL.createObjectURL(
          new Blob([JSON.stringify(paifudata, null, "  ")],
          {type: "text/plain"}));
      a.download = "mahjongsoul_paifu.json";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
{% endblock %}